<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css"/>
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <script src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
  
  <title>{{flask_token}}</title>

</head>
<body>
    <div class="row d-flex pt-5 pb-5 justify-content-center ">
        <h1>{{flask_token}}</h1>
    </div>
    <div class="row d-flex pt-5 pb-5 justify-content-center ">
        <button type="button" class="btn btn-primary" id="getdata-btn" name="get data" value="get data">Get data</button>
    </div>
    <div class="row d-flex justify-content-center">
        
        <table id="summary" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>Info</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th>Info</th>
                    <th>Details</th>
                </tr>
            </tfoot>
        </table>
    </div>
    <div class="row d-flex pt-5 pb-5 justify-content-center ">
        <div id='bar-chart'></div>
    </div>
    <div class="row d-flex justify-content-center">
        
        <table id="example" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>City</th>
                    <th>Cases</th>
                    <th>Rate</th>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th>City</th>
                    <th>Cases</th>
                    <th>Rate</th>  
                </tr>
            </tfoot>
        </table>
    </div>
   
    <script>

   
    function draw_bar_chart() {
        $.ajax({
            type: "GET",
            url: "/get_results",
            success: function(response){
                cities = [];
                cases = [];
                for (i = 0; i < response.data.length; i++) {
                    if (response.data[i].city.startsWith("Los Angeles - ")){
                        if (response.data[i].cases === '--' ||
                            response.data[i].cases === '0') {
                            continue;
                        }
                        city = response.data[i].city.replace("Los Angeles - ", "");
                        cities.push(city);
                        cases.push(response.data[i].cases);
                        continue;
                    }
                }
                points = []
                for (i = 0; i < cities.length; i++){
                  points.push({ 'city': cities[i], 'cases': cases[i] } )
                }
                points.sort(function(a, b) { return (b.cases - a.cases)});
                cities=[]
                cases=[]
                for (i = 0; i < 10; i++ ){
                   cities[i] = points[i].city
                   cases[i] = points[i].cases
                }
                var trace1 = {
                type: 'bar',
                x: cities,
                y: cases,
                marker: {
                    color: '#C8A2C8',
                    line: {
                        width: 2.5
                    }
                }
                };

                var data = [ trace1 ];

                var layout = { 
                    title: 'Highest rates of infections',
                    font: {size: 16}
                };

                var config = {responsive: true}

                Plotly.newPlot('bar-chart', data, layout, config );
            }
        })
    }

    const button = document.getElementById('getdata-btn');
    button.addEventListener('click', async _ => {
        try {
            const response = await fetch('/start_crawling', {
                method: 'post',
                body: {}
            });
            console.log('posted start crawl', response);
        }catch(err) {
            console.error(`Error: ${err}`);
        }
        window.location.reload();
        draw_bar_chart();
    });
    function setupData(){
        $(document).ready(function() {
            $.ajax({type: "POST", url: "/start_crawling"});

            $('#example').DataTable({
                "ajax": {
                    "url": "/get_results", 
                    "dataType": "json",
                    "dataSrc": "data",
                    "contentType":"application/json"
                },
                "lengthMenu": [[10,50,100,200,300,400,-1], [10,50,100,200,300,400,"all"]],
                "pageLength": 30,
                "columns": [
                    { "data": "city" },
                    { "data": "cases" },
                    { "data": "rate" }
                ]
                } );
            } );

            $('#summary').DataTable({
                "ajax": {
                    "url": "/get_summary",
                    "dataType": "json",
                    "dataSrc": "data",
                    "contentType":"application/json"
                },
                "ordering": false,
                "lengthMenu": [[10,50,100,200,300,400,-1], [10,50,100,200,300,400,"all"]],
                "pageLength": 30,
                "columns": [
                    { "data": "info" },
                    { "data": "details" }
                ]
                } );
    }
    async function asyncSetup() {
      $.ajax({type: "POST", url: "/start_crawling"});
      let promise = new Promise((res,rej) => {
        setTimeout(() => res("done"), 1000)
      });
      let result = await promise;
      setupData();
      draw_bar_chart();
    };

    $( window ).on( "load", asyncSetup );

    //draw_bar_chart();
    
    </script>
</body>
</html>
